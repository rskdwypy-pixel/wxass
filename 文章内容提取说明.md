# 文章详情页面内容提取说明

## 概述

本文档详细说明了在文章详情页面如何获取文章标题和正文内容，以及如何将其保存到素材库。

---

## 技术实现

### 1. 页面加载流程

#### 1.1 WebView 加载文章
文件位置: [ArticleDetailViewController.m:64-70](mosswc/ArticleDetailViewController.m#L64-L70)

```objective-c
- (void)loadArticle {
    [self.loadingView startAnimating];

    NSURL *url = [NSURL URLWithString:self.article.link];
    NSURLRequest *request = [NSURLRequest requestWithURL:url];
    [self.webView loadRequest:request];
}
```

**说明**:
- 使用 WKWebView 加载微信公众号文章链接
- 显示加载动画提示用户等待
- 文章链接格式: `https://mp.weixin.qq.com/s/xxxxx`

---

### 2. 内容提取

#### 2.1 JavaScript 提取正文
文件位置: [ArticleDetailViewController.m:74-84](mosswc/ArticleDetailViewController.m#L74-L84)

```objective-c
- (void)webView:(WKWebView *)webView didFinishNavigation:(WKNavigation *)navigation {
    [self.loadingView stopAnimating];

    // 提取文章正文内容
    NSString *js = @"document.querySelector('#js_content').innerText";
    [webView evaluateJavaScript:js completionHandler:^(id result, NSError *error) {
        if (result) {
            self.articleContent = result;
        }
    }];
}
```

**关键点**:
- **时机**: 在 WebView 加载完成后执行
- **目标元素**: `#js_content` - 微信公众号文章的正文容器
- **提取方法**: 使用 `innerText` 获取纯文本内容（自动去除 HTML 标签）
- **存储**: 将提取的内容保存到 `self.articleContent` 属性

#### 2.2 微信文章 HTML 结构

微信公众号文章的标准 HTML 结构:

```html
<div id="page-content">
    <div id="img-content">
        <h1 id="activity-name">文章标题</h1>
        <div id="meta_content">
            <!-- 作者、发布时间等元信息 -->
        </div>
        <div id="js_content" class="rich_media_content">
            <!-- 文章正文内容 -->
            <p>段落1</p>
            <p>段落2</p>
            ...
        </div>
    </div>
</div>
```

**重要元素**:
- `#activity-name`: 文章标题
- `#js_content`: 文章正文容器
- `.rich_media_content`: 富文本内容类名

---

### 3. 标题获取

#### 3.1 从 Article 对象获取
文件位置: [ArticleDetailViewController.m:115](mosswc/ArticleDetailViewController.m#L115)

```objective-c
titleTextView.text = self.article.title;
```

**说明**:
- 标题在获取文章列表时已经从 API 返回
- 存储在 `Article` 对象的 `title` 属性中
- 无需从 HTML 页面再次提取

#### 3.2 如果需要从页面提取标题

如果需要从 HTML 页面提取标题（例如标题可能被修改），可以使用:

```javascript
document.querySelector('#activity-name').innerText
```

或者:

```javascript
document.querySelector('h1.rich_media_title').innerText
```

---

### 4. 内容展示与编辑

#### 4.1 弹出编辑卡片
文件位置: [ArticleDetailViewController.m:95-155](mosswc/ArticleDetailViewController.m#L95-L155)

当用户点击"获取文案"按钮时，显示一个编辑卡片:

```objective-c
- (void)showContentCard {
    // 1. 创建半透明遮罩层
    UIView *overlay = [[UIView alloc] initWithFrame:self.view.bounds];
    overlay.backgroundColor = [[UIColor blackColor] colorWithAlphaComponent:0.5];

    // 2. 创建白色卡片
    UIView *card = [[UIView alloc] initWithFrame:CGRectMake(20, 100, cardWidth, cardHeight)];

    // 3. 标题输入框
    UITextView *titleTextView = [[UITextView alloc] init];
    titleTextView.text = self.article.title;

    // 4. 正文输入框
    UITextView *contentTextView = [[UITextView alloc] init];
    contentTextView.text = self.articleContent;

    // 5. 取消和提交按钮
    UIButton *cancelButton = [UIButton buttonWithType:UIButtonTypeSystem];
    UIButton *submitButton = [UIButton buttonWithType:UIButtonTypeSystem];
}
```

**卡片布局**:
```
┌─────────────────────────────┐
│ 标题                         │
│ ┌─────────────────────────┐ │
│ │ [可编辑的标题文本框]     │ │
│ └─────────────────────────┘ │
│                             │
│ 正文                         │
│ ┌─────────────────────────┐ │
│ │                         │ │
│ │ [可编辑的正文文本框]     │ │
│ │                         │ │
│ │                         │ │
│ └─────────────────────────┘ │
│                             │
│ [取消]          [提交]       │
└─────────────────────────────┘
```

---

### 5. 保存到素材库

#### 5.1 提交素材
文件位置: [ArticleDetailViewController.m:161-186](mosswc/ArticleDetailViewController.m#L161-L186)

```objective-c
- (void)submitMaterial {
    // 1. 获取编辑后的标题和正文
    UITextView *titleTextView = [overlay viewWithTag:1001];
    UITextView *contentTextView = [overlay viewWithTag:1002];

    NSString *title = titleTextView.text;
    NSString *content = contentTextView.text;

    // 2. 验证内容
    if (!title || title.length == 0 || !content || content.length == 0) {
        [self showAlert:@"标题和正文不能为空"];
        return;
    }

    // 3. 创建素材对象
    NSString *materialId = [self extractMaterialIdFromLink:self.article.link];
    Material *material = [[Material alloc] initWithId:materialId
                                                 title:title
                                               content:content];

    // 4. 保存到数据库
    [[DataManager sharedManager] saveMaterial:material];

    // 5. 更新按钮状态
    self.navigationItem.rightBarButtonItem.title = @"文案已保存";
    self.navigationItem.rightBarButtonItem.enabled = NO;
}
```

#### 5.2 素材 ID 生成
文件位置: [ArticleDetailViewController.m:31-39](mosswc/ArticleDetailViewController.m#L31-L39)

```objective-c
- (NSString *)extractMaterialIdFromLink:(NSString *)link {
    // 从链接中提取最后一段作为ID
    // 例如: https://mp.weixin.qq.com/s/abc123 -> abc123
    NSArray *components = [link componentsSeparatedByString:@"/"];
    NSString *lastComponent = components.lastObject;

    // 去掉查询参数
    NSArray *parts = [lastComponent componentsSeparatedByString:@"?"];
    return parts.firstObject ?: lastComponent;
}
```

**示例**:
- 输入: `https://mp.weixin.qq.com/s/abc123?scene=123`
- 输出: `abc123`

---

## 数据流程图

```
┌─────────────────┐
│  加载文章页面    │
│  (WebView)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 页面加载完成     │
│ didFinishNav    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 执行 JavaScript  │
│ 提取 #js_content│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 保存到属性       │
│ articleContent  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 用户点击按钮     │
│ "获取文案"      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 显示编辑卡片     │
│ 标题 + 正文     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 用户编辑并提交   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 保存到素材库     │
│ DataManager     │
└─────────────────┘
```

---

## 关键技术点

### 1. WKWebView JavaScript 执行

**优点**:
- 可以访问完整的 DOM 结构
- 支持复杂的 JavaScript 操作
- 异步执行，不阻塞主线程

**注意事项**:
- 必须在页面加载完成后执行
- 需要处理执行失败的情况
- JavaScript 代码需要符合页面的 CSP 策略

### 2. innerText vs innerHTML

| 属性 | 说明 | 适用场景 |
|------|------|----------|
| innerText | 获取纯文本，自动去除 HTML 标签 | 提取文章正文 |
| innerHTML | 获取 HTML 代码，包含所有标签 | 需要保留格式 |
| textContent | 获取所有文本节点，包括隐藏元素 | 完整文本提取 |

**本项目选择**: `innerText` - 因为只需要纯文本内容，不需要 HTML 格式

### 3. 防重复保存机制

文件位置: [ArticleDetailViewController.m:19-25](mosswc/ArticleDetailViewController.m#L19-L25)

```objective-c
NSString *materialId = [self extractMaterialIdFromLink:self.article.link];
BOOL isSaved = [[DataManager sharedManager] isMaterialSaved:materialId];

UIBarButtonItem *extractButton = [[UIBarButtonItem alloc]
    initWithTitle:isSaved ? @"文案已保存" : @"获取文案"
    style:UIBarButtonItemStylePlain
    target:self
    action:@selector(extractContent)];
extractButton.enabled = !isSaved;
```

**机制**:
- 使用文章链接的唯一标识作为素材 ID
- 页面加载时检查是否已保存
- 已保存则禁用按钮，防止重复保存

---

## 浏览器插件实现参考

如果要在浏览器插件中实现相同功能，可以参考以下方案:

### 1. Content Script 注入

```javascript
// content.js
function extractArticleContent() {
    // 提取标题
    const title = document.querySelector('#activity-name')?.innerText ||
                  document.querySelector('h1.rich_media_title')?.innerText;

    // 提取正文
    const content = document.querySelector('#js_content')?.innerText;

    // 提取作者
    const author = document.querySelector('#js_name')?.innerText;

    // 提取发布时间
    const publishTime = document.querySelector('#publish_time')?.innerText;

    return {
        title,
        content,
        author,
        publishTime,
        url: window.location.href
    };
}

// 监听来自 popup 的消息
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    if (request.action === 'extractContent') {
        const data = extractArticleContent();
        sendResponse(data);
    }
});
```

### 2. Popup 界面

```javascript
// popup.js
document.getElementById('extractBtn').addEventListener('click', async () => {
    // 获取当前标签页
    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });

    // 发送消息到 content script
    chrome.tabs.sendMessage(tab.id, { action: 'extractContent' }, (response) => {
        if (response) {
            // 显示提取的内容
            document.getElementById('title').value = response.title;
            document.getElementById('content').value = response.content;
        }
    });
});
```

---

## 常见问题

### Q1: 为什么有时候提取不到内容？

**原因**:
- 页面还未完全加载完成
- JavaScript 执行时机过早
- 页面结构发生变化

**解决方案**:
```objective-c
// 添加延迟或重试机制
dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1.0 * NSEC_PER_SEC)),
               dispatch_get_main_queue(), ^{
    [self extractContent];
});
```

### Q2: 如何处理图片和视频？

**当前实现**: 只提取纯文本，不包含图片和视频

**如果需要保留**:
```javascript
// 使用 innerHTML 而不是 innerText
document.querySelector('#js_content').innerHTML
```

### Q3: 如何提取文章的其他元信息？

```javascript
// 作者
document.querySelector('#js_name').innerText

// 发布时间
document.querySelector('#publish_time').innerText

// 阅读数
document.querySelector('#readNum').innerText

// 点赞数
document.querySelector('#likeNum').innerText
```

---

## 总结

### 核心流程
1. **加载页面**: 使用 WKWebView 加载文章链接
2. **等待完成**: 监听 `didFinishNavigation` 回调
3. **执行 JS**: 使用 `evaluateJavaScript` 提取 `#js_content`
4. **展示编辑**: 弹出卡片显示标题和正文
5. **保存素材**: 将编辑后的内容保存到本地数据库

### 关键代码位置
- WebView 加载: [ArticleDetailViewController.m:64-70](mosswc/ArticleDetailViewController.m#L64-L70)
- 内容提取: [ArticleDetailViewController.m:74-84](mosswc/ArticleDetailViewController.m#L74-L84)
- 编辑界面: [ArticleDetailViewController.m:95-155](mosswc/ArticleDetailViewController.m#L95-L155)
- 保存素材: [ArticleDetailViewController.m:161-186](mosswc/ArticleDetailViewController.m#L161-L186)

### 技术要点
- 使用 `innerText` 提取纯文本
- 在页面加载完成后执行 JavaScript
- 通过文章链接生成唯一 ID
- 防止重复保存机制
